<?php  App::uses('CakeEmail', 'Network/Email');   class HomeController extends AppController {   public function index() {   $this->layout="index"; $this->loadModel('Organisers'); $this->loadModel('registration'); $this->loadModel('Admin'); $this->loadModel('Hospitality'); $this->loadModel('Mega_sponsor'); $this->loadModel('Our_partner'); $this->loadModel('Prev_sponsor'); $this->loadModel('Contact'); $this->loadModel('About_Jnanagni');  $this->set('about_jnanagni',Set::extract('/About_Jnanagni/.',$this->About_Jnanagni->find('all')));  $this->set('contact_info',Set::extract('/Contact/.',$this->Contact->find('all')));  $this->set('mega_sponsor_info',Set::extract('/Mega_sponsor/.',$this->Mega_sponsor->find('all'))); $this->set('our_partner_info',Set::extract('/Our_partner/.',$this->Our_partner->find('all'))); $this->set('prev_sponsor_info',Set::extract('/Prev_sponsor/.',$this->Prev_sponsor->find('all'))); $this->set('hospitality_info',Set::extract('/Hospitality/.',$this->Hospitality->find('all')));  $this->set('admin_info',$this->Admin->find('all'));  if(!empty($this->data)){  $data=$this->data;  if($data['registration']['image']['name']!=''){ $fileOK = $this->uploadFiles('img/users pics', $data); $data['registration']['image']=$fileOK['urls']['0']; }else{ $data['registration']['image']=""; } $no_of_users=$this->registration->find('count'); $no_of_users+=101; $reg_id="jnanagni'15_".$no_of_users; $data['registration']['reg_id']=$reg_id; if($this->registration->save($data)){ $this->send_regId($data['registration']['email'],$reg_id); }else{ echo "Something went wrong Please try again!"; }  } }  protected function send_regId($email,$id){  $Email = new CakeEmail('gmail'); if($Email->from(array('bhuvthebest@gmail.com' => 'http://www.jnanagni.in')) ->to($email) ->subject('Registration Id') ->send("Your registration id is: ".$id)){ $this->Session->setFlash(__("Registration Successful. Your registration Id has been sent to ".$email)); $this->redirect('/home'); }else{ echo "Some error occured Please try later"; }   $this->autoRender=false;  }  function login($user=null,$pass=null){ $this->loadModel('registration'); $this->loadModel('Organisers'); $this->loadModel('Admin');  if($this->registration->findByreg_id($user)){ $reg_id=$this->registration->findByreg_id($user); if($pass==$reg_id['registration']['password']){ $this->Session->write('User.jnanagni_fest','1'); $this->Session->write('User.reg_id',$reg_id['registration']['reg_id']); $this->Session->write('User.name',$reg_id['registration']['name']); $this->Session->write('User.image',$reg_id['registration']['image']); $this->Session->write('User.role',$reg_id['registration']['role']); echo 'done'; } else{ echo "Password does not match Please try again"; } } else if($this->Organisers->find('first',array('conditions'=>array('id'=>$user,'status'=>1)))){ $reg_id=$this->Organisers->find('first',array('conditions'=>array('id'=>$user,'status'=>1))); if($pass==$reg_id['Organisers']['password']){ $this->Session->write('User.jnanagni_fest','1'); $this->Session->write('User.reg_id',$reg_id['Organisers']['id']); $this->Session->write('User.name',$reg_id['Organisers']['name']); $this->Session->write('User.image',$reg_id['Organisers']['image']); $this->Session->write('User.role',$reg_id['Organisers']['role']); echo 'done'; } else{ echo "Password does not match Please try again"; } } else if($this->Admin->find('first',array('conditions'=>array('id'=>$user,'status'=>1)))){ $reg_id=$this->Admin->find('first',array('conditions'=>array('id'=>$user,'status'=>1))); if($pass==$reg_id['Admin']['password']){ $this->Session->write('User.jnanagni_fest','1'); $this->Session->write('User.reg_id',$reg_id['Admin']['id']); $this->Session->write('User.name',$reg_id['Admin']['name']); $this->Session->write('User.image',$reg_id['Admin']['image']); $this->Session->write('User.role',$reg_id['Admin']['role']); echo 'done'; } else{ echo "Password does not match Please try again"; } } else{ echo "You are not registered! Please register yourself first"; }  $this->autoRender=false; }  public function events($val=null) { if($val!=''){ $this->redirect('/home/events'); } $this->layout="event"; $this->loadModel('Event'); $this->loadModel('Registered_Event'); $data=Set::extract('/Event/.',$this->Event->find('all'));  $this->set('event_info',$data);  if($this->Session->read('User.jnanagni_fest')=='1' && $this->Session->read('User.role')=="user"){ $registered_event=$this->Registered_Event->find('list',array('conditions'=>array('uid'=>$this->Session->read('User.reg_id'),'status'=>1),'fields'=>array('eid')));  $this->set('registered_event_list',$registered_event); } }  function eventRegister($eventID){  if($this->Session->read('User.jnanagni_fest')!='1'){ echo "You are not logged in. Kindly log in to your account first."; }else{ $this->loadModel('Registered_Event');  $data['uid']=$this->Session->read('User.reg_id'); $data['eid']=$eventID;  $count=Set::extract('/Registered_Event/.',$this->Registered_Event->find('all',array('conditions'=>array('uid'=>$data['uid'],'eid'=>$data['eid']))));  if(empty($count)){ if($this->Registered_Event->save($data)){ echo "register"; }else{ echo "Some error occured! Not registered yet!"; } } else if($count[0]['status']==1){ $data['id']=$count[0]['id']; $data['status']=0; if($this->Registered_Event->save($data)){ echo "unregister"; }else{ echo "Some error occured! you are still registered!"; } }else if($count[0]['status']==0){ $data['id']=$count[0]['id']; $data['status']=1; if($this->Registered_Event->save($data)){ echo "register"; }else{ echo "Some error occured! Not registered yet!"; } } } $this->autoRender=false; }  public function logout(){ $this->Session->destroy(); $this->redirect('/home'); }  public function error_404(){ $this->layout="error_404"; }  function forgot_password($email=null){ $this->loadModel('Organisers'); $this->loadModel('registration'); $this->loadModel('Admin');  $user=$this->registration->findByemail($email);  if(!empty($user)){ $password=$user['registration']['password']; }else{ $organiser=$this->Organisers->findByemail($email); if(!empty($organiser)){ $password=$organiser['Organisers']['password']; }else{ $admin=$this->Admin->findByemail($email); if(!empty($admin)){ $password=$admin['Admin']['password']; } else{ echo "You are not registered here!!"; exit(); } } }  $Email = new CakeEmail('gmail'); if($Email->from(array('bhuvthebest@gmail.com' => 'http://www.jnanagni.in')) ->to($email) ->subject('Recovered Password') ->send("Your password is: ".$password)){ echo "done"; }else{ echo "Some error occured Please try later"; }   $this->autoRender=false; } }